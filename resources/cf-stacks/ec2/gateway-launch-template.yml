Type: AWS::EC2::LaunchTemplate
Properties:
  LaunchTemplateName: apollo-gateway-ec2-launch-${opt:env}
  LaunchTemplateData:
    ImageId: ami-0c2b8ca1dad447f8a
    InstanceType: t2.small
    KeyName: jfmprod
    SecurityGroups:
      - !Ref ApolloGatewaySecurityGroup
    UserData: !Base64 |
      #!/bin/bash -ex
      touch ~/.bashrc 
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash
      source ~/.bashrc
      nvm install node
      npm install -g npm
      npm install -g pm2
      mkdir -p /opt/apollo-gateway/apps/api-gateway
      aws s3 cp s3://core-apollo-gateway/ /opt/apollo-gateway/ --include "*" --recursive
      mv /opt/apollo-gateway/schema.graphql /opt/apollo-gateway/apps/api-gateway
      cd /opt/apollo-gateway
      npm install --only=prod --legacy-peer-deps
      pm2 start main.js
      pm2 save
