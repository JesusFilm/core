Type: AWS::EC2::Instance
DependsOn: ApolloGatewaySecurityGroup
Properties:
  ImageId: ami-0c2b8ca1dad447f8a
  InstanceType: t2.small
  KeyName: jfmprod
  SubnetId: subnet-99b842c3
  SecurityGroupIds:
    - !Ref ApolloGatewaySecurityGroup
  UserData: !Base64 |
    #!/bin/bash -ex
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash
    echo 'export NVM_DIR="/root/.nvm"' >> /root/.bashrc
    echo '[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm' >> /root/.bashrc
    . /root/.nvm/nvm.sh
    nvm install node
    npm install -g npm
    npm install -g pm2
    mkdir -p /opt/apollo-gateway/apps/api-gateway
    aws s3 cp s3://core-apollo-gateway/* /opt/apollo-gateway
    mv /opt/apollo-gateway/schema.graphql /opt/apollo-gateway/apps/api-gateway
    cd /opt/apollo-gateway
    npm install --only=prod
    pm2 start main.js
    pm2 save
