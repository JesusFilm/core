# ENG-2822: AI Chat Simplified Tools Architecture

## Overview

Implement a simplified tool architecture for the AI Chat feature to address scalability, cost, and maintainability challenges in journey creation and editing. This approach reduces AI tool calls by 80-90% while enabling more intuitive journey generation, transforming the AI Chat from a technical editing assistant into a creative journey generation platform.

## Problem Statement

The current AI Chat tool architecture faces significant scalability and usability challenges that limit its effectiveness and growth potential:

1. **High Tool Call Volume**: Creating a simple step with button requires 5+ individual tool calls, with each block operation (create, update, delete) being a separate API call. This scales poorly with user growth and becomes expensive at high volume.

2. **AI Cognitive Complexity**: The AI spends significant computational budget on GraphQL mutations and block relationships rather than creative journey design. Complex system prompts focus on technical implementation details, leading to error-prone block hierarchy management (StepBlock → CardBlock → ChildBlocks).

3. **Generative Journey Limitations**: Current tools are optimized for editing existing journeys but struggle with creating complete journeys from single prompts. The AI is limited by technical complexity rather than creative capability, making it difficult to achieve the vision of effortless journey creation at scale.

## Requirements

### Functional Requirements

1. **JourneySimpleGet Tool**

   - Accept a journey ID as input parameter
   - Query existing journey data using current database structure
   - Transform complex block hierarchy to simplified JSON format
   - Return clean, intuitive journey representation
   - Validate output using Zod schema before returning

2. **JourneySimpleUpdate Tool**

   - Accept journey ID and complete simplified journey JSON as input
   - Fully replace the existing journey with the provided JSON using the journey ID
   - Return success/failure status with validation results
   - Prevent partial updates that could corrupt journey state by validating the entire input before replacement

3. **Simplified JSON Structure**

   - **Journey Object**: Contains title, description, and cards
   - **Cards Array**: Sequential content flow with content items
   - **Content Types**: Support heading, text, button, poll, image, background-image
   - **Navigation Flow**: NextCard linking between cards
   - **Validation**: Full Zod schema validation for type safety

4. **Backend GraphQL Integration**

   - Add `journeySimpleGet(id: ID!): Json!` query
   - Add `journeySimpleUpdate(id: ID!, journey: Json!): Json!` mutation
   - Use JSON scalar type for maximum flexibility
   - Follow existing journey naming conventions

5. **Transformation Layer**
   - Convert StepBlock → CardBlock → ChildBlocks hierarchy to simplified steps
   - Map TypographyBlock, ButtonBlock, ImageBlock to content types
   - Preserve all essential journey information without data loss
   - Handle complex edge cases and nested structures

### Non-Functional Requirements

1. **Performance**

   - Achieve 80-90% reduction in tool calls per journey operation
   - Optimize database queries for transformation efficiency
   - Minimize API payload sizes and round trips
   - Complete transformations in reasonable time for large journeys

2. **Scalability**

   - Support growth from 2,500 to 25,000 creators
   - Handle concurrent journey operations efficiently
   - Maintain performance as journey complexity increases

3. **Reliability**

   - Validate the entire input before replacing the journey to prevent partial failures
   - Comprehensive error handling with graceful degradation
   - Rollback capability for failed operations
   - Robust validation at all input/output points

4. **Maintainability**
   - Centralize validation and transformation logic in testable backend code
   - Isolate AI tools from complex database structure changes
   - Clear separation of concerns between frontend and backend

## Design Specifications

### Simplified JSON Structure

```json
{
  "journey": {
    "title": "Journey Title",
    "description": "Journey description",
    "cards": [
      {
        "heading": "Welcome",
        "text": "Journey content...",
        "button": { "text": "Continue", "nextCard": 1 },
        "poll": [
          { "text": "Option 1", "nextCard": 2 },
          { "text": "Option 2", "nextCard": 3 }
        ],
        "image": "https://...",
        "backgroundImage": "https://...",
        "nextCard": 1
      }
    ]
  }
}
```

### Content Type Definitions

- **heading**: Text heading for the card (optional)
- **text**: Plain text content for the card (optional)
- **button**: Object with `text` and `nextCard` (optional)
- **poll**: Array of objects, each with `text` and `nextCard` (optional)
- **image**: URL string for an image (optional)
- **backgroundImage**: URL string for a background image (optional)
- **nextCard**: Integer index of the next card in the cards array (optional)

### User Experience Flow

1. AI receives user request for journey creation/modification
2. AI calls JourneySimpleGet to retrieve current state (if editing)
3. AI processes user intent using simplified, intuitive format
4. AI generates complete journey using simplified structure
5. AI calls JourneySimpleUpdate with complete journey data
6. Backend fully replaces the journey with the provided JSON after validation
7. User sees updated journey in editor interface

## Technical Considerations

### Implementation Architecture

- **Framework**: React with TypeScript for frontend tools
- **Backend**: Node.js with GraphQL using existing API patterns
- **Database**: Prisma ORM with existing Journey/Block schema
- **Validation**: Zod schemas for runtime type safety
- **Error Handling**: Consistent try-catch patterns with existing tools

### File Structure

```
apps/journeys-admin/src/libs/ai/tools/journey/simple/
├── types.ts                    # SimplifiedJourney interfaces & Zod schemas
├── journeySimpleGet.ts         # Frontend tool for retrieving journeys
└── journeySimpleUpdate.ts      # Frontend tool for updating journeys

apis/api-journeys/src/
├── schema/journey.graphql      # GraphQL schema extensions
└── resolvers/journey/
    ├── journeySimpleGet.ts     # Query resolver
    └── journeySimpleUpdate.ts  # Mutation resolver
```

### Schema Validation Strategy

- **Shared Types**: Define SimplifiedJourney interface in tool types
- **Zod Schemas**: Both tools use identical schema with `satisfies z.ZodType<SimplifiedJourney>`
- **Frontend Validation**: Input validation for journey ID and complete JSON
- **Backend Validation**: Output validation to ensure transformation correctness
- **Error Prevention**: Catch AI formatting errors before expensive backend operations

### Branching Strategy

```
25-03-NC-feat-ai-guided-journey-ui                    # Current feature branch
├── 25-04-JC-feat-ai-simple-journey-backend          # Backend: GraphQL schema + resolvers
└── 25-04-JC-feat-ai-simple-journey-frontend         # Frontend: Tools + types + integration
```

## Implementation Guidelines

### Phase 1: Foundation Layer (Frontend Branch)

1. **Create SimplifiedJourney types** in `tools/journey/simple/types.ts`
2. **Define Zod schemas** with comprehensive validation and descriptions
3. **Establish content types** starting with basic journey structure
4. **Implement parameter schemas** for both JourneySimpleGet and JourneySimpleUpdate

### Phase 2: Backend Infrastructure (Backend Branch)

1. **Add GraphQL schema extensions** for journeySimpleGet and journeySimpleUpdate
2. **Create transformation layer** to convert complex database structure
3. **Implement full replacement logic for journey updates**
4. **Build comprehensive resolver functions** with error handling

### Phase 3: Frontend Tools (Frontend Branch)

1. **Build JourneySimpleGet tool** with GraphQL integration
2. **Implement JourneySimpleUpdate tool** with full journey validation
3. **Add tools to AI Chat system** following existing patterns

### Phase 4: Integration & Testing

## Success Metrics

The simplified tools architecture is considered successful when:

1. **Tool Call Reduction**: Achieve 80-90% fewer calls per journey operation
2. **Journey Creation Speed**: Demonstrate faster complete journey generation from prompts
3. **AI Response Quality**: Show improved journey design and user experience
4. **Error Rate Reduction**: Fewer technical implementation errors in AI responses
5. **Performance**: All existing journeys transform successfully without data loss
6. **Schema Validation**: 100% of generated simplified journeys pass validation
7. **User Experience**: AI can create complete journeys from single descriptive prompts

## Risk Mitigation

1. **Gradual Migration**: Maintain existing tools during transition period to ensure no disruption
2. **Rollback Capability**: Design system for easy reversion to current approach if issues arise
3. **Performance Monitoring**: Track transformation times and optimize for large journey handling
4. **Data Validation**: Multiple validation layers to catch errors before they reach the database

## Future Vision

This architecture enables the strategic vision outlined in the original pitch document:

1. **Template Personalization**: AI can efficiently customize existing journey templates for different contexts, languages, and visual identities
2. **Generative Creation**: Enable complete journey creation from single prompts like "Create a journey explaining Catholic vs. Protestant differences"
3. **Scalable Growth**: Technical foundation to support growth from 2,500 to 25,000 Next Steps creators
4. **Enhanced Creativity**: AI cognitive budget spent on journey design rather than technical implementation
5. **Reduced Costs**: Dramatic reduction in API call volume makes the system economically viable at scale

## Implementation Status

This PRD defines the requirements for implementing the AI Chat Simplified Tools Architecture. The implementation will follow the phased approach outlined above, with the first phase focusing on establishing the foundation types and schemas before moving to backend and frontend tool development.

Key deliverables include:

- SimplifiedJourney TypeScript interfaces and Zod schemas
- GraphQL schema extensions for simplified journey operations
- Backend transformation and full replacement engine
- Frontend AI tools for JourneySimpleGet and JourneySimpleUpdate

Success will be measured by the dramatic reduction in tool calls, improved AI journey generation capabilities, and maintained data integrity throughout the transformation process.
