name: Visual Test
on:
  push:
    branches: [never]
  # push:
  #   branches: [main, feature/*]
  # pull_request:
  #   branches: [main, feature/*]
  #   types: [labeled, synchronize]
  # merge_group:
  #   branches: [main]
jobs:
  visual-test:
    runs-on: blacksmith-2vcpu-ubuntu-2204
    strategy:
      matrix:
        node-version: [22]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check branch up to date with base
        run: ./tools/scripts/check-git-diff.sh
      - uses: useblacksmith/setup-node@v5
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install pnpm
        run: |
          export PNPM_HOME="$HOME/.pnpm"
          export PATH="$PNPM_HOME:$PATH"
          curl -fsSL https://get.pnpm.io/install.sh | sh -s -- --version 9.0.0
          echo "PNPM_HOME=$PNPM_HOME" >> $GITHUB_ENV
          echo "$PNPM_HOME" >> $GITHUB_PATH
      - name: Configure pnpm store
        run: pnpm config set store-dir ~/.pnpm-store
      - name: Get Node Version
        id: node-version
        run: echo "version=$(node -v)" >> $GITHUB_OUTPUT
      - name: Mount pnpm store
        uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-${{ steps.node-version.outputs.version }}-pnpm-store
          path: ~/.pnpm-store
      - name: Install dependencies
        run: pnpm install --silent
      - uses: nrwl/nx-set-shas@v4
      - name: nx Install
        run: pnpm add -g nx --silent
      - name: Build Stories
        id: build-storybook
        run: nx affected --target=build-storybook shared-storybook --webpack-stats-json
      # ADD CHROMATIC BACK DURING A COOLDOWN
      # - name: Check for frontend changes
      #   id: check_files
      #   uses: andstor/file-existence-action@v3
      #   with:
      #     files: 'dist/storybook/shared-storybook'
      #ðŸ‘‡ Adds Chromatic as a step in the workflow
      # - name: Run VR tests
      #   if: ${{ steps.check_files.outputs.files_exists == 'true' }}
      #   uses: chromaui/action@v1
      #   # Options required for Chromatic's GitHub Action
      #   # https://www.chromatic.com/docs/github-actions#available-options
      #   # https://github.com/chromaui/chromatic-cli/blob/main/action.yml
      #   with:
      #     #ðŸ‘‡ Chromatic projectToken, see https://storybook.js.org/tutorials/intro-to-storybook/react/en/deploy/ to obtain it
      #     projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     storybookBuildDir: 'dist/storybook/shared-storybook'
      #     exitOnceUploaded: 'true'
      #     autoAcceptChanges: 'main'
      #     onlyChanged: 'true'
      #     skip: '@(dependabot/**|00-00-CI-chore-update-translations)'
      #     untraced: '@(package*.json|.storybook/**)'
      #     traceChanged: 'expanded'
      # dryRun: 'true'
      # debug: 'true'
