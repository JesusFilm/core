name: API push build
on:
  push:
    branches:
      - stage
jobs:
  api-journeys:
    uses: JesusFilm/core/.github/workflows/api-deploy-worker.yml@stage
    with:
      name: api-journeys
      repository: jfp-api-journeys-stage
      branch: ${{ github.ref_name }}
      ecs_cluster: jfp-ecs-cluster-stage
      ecs_service: api-journeys-stage-service
      endpoint_url: http://api-journeys.service.internal:4001/graphql
    secrets:
      APOLLO_KEY: ${{ secrets.APOLLO_KEY }}
      ARANGODB_URL: ${{ secrets.ARANGODB_URL }}
      ARANGODB_USER: ${{ secrets.ARANGODB_USER }}
      ARANGODB_PASS: ${{ secrets.ARANGODB_PASS }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      ARCLIGHT_API_KEY: ${{ secrets.ARCLIGHT_API_KEY }}
      JFP_AWS_ACCESS_KEY_ID: ${{ secrets.JFP_AWS_ACCESS_KEY_ID }}
      JFP_AWS_SECRET_ACCESS_KEY: ${{ secrets.JFP_AWS_SECRET_ACCESS_KEY }}
      CA_CRT: ${{ secrets.CA_CRT }}
      USER_CRT: ${{ secrets.USER_CRT }}
      USER_KEY: ${{ secrets.USER_KEY }}
  api-users:
    uses: JesusFilm/core/.github/workflows/api-deploy-worker.yml@stage
    with:
      name: api-users
      repository: jfp-api-users-stage
      branch: ${{ github.ref_name }}
      ecs_cluster: jfp-ecs-cluster-stage
      ecs_service: api-users-stage-service
      endpoint_url: http://api-users.service.internal:4002/graphql
    secrets:
      APOLLO_KEY: ${{ secrets.APOLLO_KEY }}
      ARANGODB_URL: ${{ secrets.ARANGODB_URL }}
      ARANGODB_USER: ${{ secrets.ARANGODB_USER }}
      ARANGODB_PASS: ${{ secrets.ARANGODB_PASS }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      ARCLIGHT_API_KEY: ${{ secrets.ARCLIGHT_API_KEY }}
      JFP_AWS_ACCESS_KEY_ID: ${{ secrets.JFP_AWS_ACCESS_KEY_ID }}
      JFP_AWS_SECRET_ACCESS_KEY: ${{ secrets.JFP_AWS_SECRET_ACCESS_KEY }}
      CA_CRT: ${{ secrets.CA_CRT }}
      USER_CRT: ${{ secrets.USER_CRT }}
      USER_KEY: ${{ secrets.USER_KEY }}
  api-languages:
    uses: JesusFilm/core/.github/workflows/api-deploy-worker.yml@stage
    with:
      name: api-languages
      repository: jfp-api-languages-stage
      branch: ${{ github.ref_name }}
      ecs_cluster: jfp-ecs-cluster-stage
      ecs_service: api-languages-stage-service
      endpoint_url: http://api-languages.service.internal:4003/graphql
    secrets:
      APOLLO_KEY: ${{ secrets.APOLLO_KEY }}
      ARANGODB_URL: ${{ secrets.ARANGODB_URL }}
      ARANGODB_USER: ${{ secrets.ARANGODB_USER }}
      ARANGODB_PASS: ${{ secrets.ARANGODB_PASS }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      ARCLIGHT_API_KEY: ${{ secrets.ARCLIGHT_API_KEY }}
      JFP_AWS_ACCESS_KEY_ID: ${{ secrets.JFP_AWS_ACCESS_KEY_ID }}
      JFP_AWS_SECRET_ACCESS_KEY: ${{ secrets.JFP_AWS_SECRET_ACCESS_KEY }}
      CA_CRT: ${{ secrets.CA_CRT }}
      USER_CRT: ${{ secrets.USER_CRT }}
      USER_KEY: ${{ secrets.USER_KEY }}
  api-videos:
    uses: JesusFilm/core/.github/workflows/api-deploy-worker.yml@stage
    with:
      name: api-videos
      repository: jfp-api-videos-stage
      branch: ${{ github.ref_name }}
      ecs_cluster: jfp-ecs-cluster-stage
      ecs_service: api-videos-stage-service
      endpoint_url: https://api-videos.service.internal:4004/graphql
    secrets:
      APOLLO_KEY: ${{ secrets.APOLLO_KEY }}
      ARANGODB_URL: ${{ secrets.ARANGODB_URL }}
      ARANGODB_USER: ${{ secrets.ARANGODB_USER }}
      ARANGODB_PASS: ${{ secrets.ARANGODB_PASS }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      ARCLIGHT_API_KEY: ${{ secrets.ARCLIGHT_API_KEY }}
      JFP_AWS_ACCESS_KEY_ID: ${{ secrets.JFP_AWS_ACCESS_KEY_ID }}
      JFP_AWS_SECRET_ACCESS_KEY: ${{ secrets.JFP_AWS_SECRET_ACCESS_KEY }}
      CA_CRT: ${{ secrets.CA_CRT }}
      USER_CRT: ${{ secrets.USER_CRT }}
      USER_KEY: ${{ secrets.USER_KEY }}

  api-gateway:
    needs: [api-journeys, api-users, api-languages, api-videos]
    uses: JesusFilm/core/.github/workflows/api-gateway-stage-worker.yml@stage
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      JFP_AWS_ACCESS_KEY_ID: ${{ secrets.JFP_AWS_ACCESS_KEY_ID }}
      JFP_AWS_SECRET_ACCESS_KEY: ${{ secrets.JFP_AWS_SECRET_ACCESS_KEY }}
      CA_CRT: ${{ secrets.CA_CRT }}
      USER_CRT: ${{ secrets.USER_CRT }}
      USER_KEY: ${{ secrets.USER_KEY }}
